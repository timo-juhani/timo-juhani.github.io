<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>VXLAN in Data Centers | Logs</title>
<meta name="keywords" content="">
<meta name="description" content="Quick Refresher
The main idea behind VXLAN in data centers is the ability to move workloads between the servers without changing the network settings and/or shutting down or restarting the workload. The business need for this capability is rooted in the reasons found from on-demand, elastic scalability, business continuity, or maintenance requirements.
VXLAN is a tunneling protocol which encapsulates the original payload and thus creates separation from the other traffic flows. The concept is similar to what VRF-based technologies implement. The tunnels start and end at VXLAN Tunnel Endpoints or VTEPs.">
<meta name="author" content="TJK">
<link rel="canonical" href="https://timo-juhani.github.io/logs/vxlan-in-data-centers/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css" integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://timo-juhani.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://timo-juhani.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://timo-juhani.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://timo-juhani.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://timo-juhani.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://timo-juhani.github.io/logs/vxlan-in-data-centers/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://timo-juhani.github.io/logs/vxlan-in-data-centers/">
  <meta property="og:site_name" content="Logs">
  <meta property="og:title" content="VXLAN in Data Centers">
  <meta property="og:description" content="Quick Refresher The main idea behind VXLAN in data centers is the ability to move workloads between the servers without changing the network settings and/or shutting down or restarting the workload. The business need for this capability is rooted in the reasons found from on-demand, elastic scalability, business continuity, or maintenance requirements.
VXLAN is a tunneling protocol which encapsulates the original payload and thus creates separation from the other traffic flows. The concept is similar to what VRF-based technologies implement. The tunnels start and end at VXLAN Tunnel Endpoints or VTEPs.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="logs">
    <meta property="article:published_time" content="2025-02-24T08:34:36+02:00">
    <meta property="article:modified_time" content="2025-02-24T08:34:36+02:00">
      <meta property="og:image" content="https://timo-juhani.github.io/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://timo-juhani.github.io/papermod-cover.png">
<meta name="twitter:title" content="VXLAN in Data Centers">
<meta name="twitter:description" content="Quick Refresher
The main idea behind VXLAN in data centers is the ability to move workloads between the servers without changing the network settings and/or shutting down or restarting the workload. The business need for this capability is rooted in the reasons found from on-demand, elastic scalability, business continuity, or maintenance requirements.
VXLAN is a tunneling protocol which encapsulates the original payload and thus creates separation from the other traffic flows. The concept is similar to what VRF-based technologies implement. The tunnels start and end at VXLAN Tunnel Endpoints or VTEPs.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Logs",
      "item": "https://timo-juhani.github.io/logs/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "VXLAN in Data Centers",
      "item": "https://timo-juhani.github.io/logs/vxlan-in-data-centers/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "VXLAN in Data Centers",
  "name": "VXLAN in Data Centers",
  "description": "Quick Refresher The main idea behind VXLAN in data centers is the ability to move workloads between the servers without changing the network settings and/or shutting down or restarting the workload. The business need for this capability is rooted in the reasons found from on-demand, elastic scalability, business continuity, or maintenance requirements.\nVXLAN is a tunneling protocol which encapsulates the original payload and thus creates separation from the other traffic flows. The concept is similar to what VRF-based technologies implement. The tunnels start and end at VXLAN Tunnel Endpoints or VTEPs.\n",
  "keywords": [
    
  ],
  "articleBody": "Quick Refresher The main idea behind VXLAN in data centers is the ability to move workloads between the servers without changing the network settings and/or shutting down or restarting the workload. The business need for this capability is rooted in the reasons found from on-demand, elastic scalability, business continuity, or maintenance requirements.\nVXLAN is a tunneling protocol which encapsulates the original payload and thus creates separation from the other traffic flows. The concept is similar to what VRF-based technologies implement. The tunnels start and end at VXLAN Tunnel Endpoints or VTEPs.\nVTEP does the encapsulation of the traffic. A VTEP comes with two interfaces. One for local bridging purposes and one to provide an IP interface towards the VXLAN core network. Depending on the case, you can see VTEPs deployed on physical switches, hypervisors, or directly on servers’ operating systems. Having all the key deployment options available should give an idea of the flexibility in setting up the tunnel infrastructure.\nSo if VTEPs are the core concept in the forwarding, how does the network learn and distribute the information about VTEPs? The two most common options are MP-BGP EVPN and flooding (multicast) control plane solutions. The forwarding decision is based on the destination MAC address. If the MAC is not local to the VTEP, the packet will be encapsulated in a VXLAN header and sent to the remote VTEP over the VXLAN core network. If the MAC is local to the VTEP, the traffic is switched just normally without VXLAN.\nTime to get hands on.\nTopology Typical CLOS topology.\nConfiguration Since we’re dealing with standalone NX-OS devices, let’s split the configuration into manageable tasks that follow a logical order.\n1. Underlay For the underlay, we need a simple OSPF setup that provides inter-loopback connectivity within the fabric. The links are point-to-point, so we don’t need the OSPF DR process to run.\nIn addition to OSPF, multicast is required to handle BUM traffic replication in the underlay. Without multicast support, VTEPs wouldn’t know where to send BUM traffic. Later in the configuration, we’ll map VNIs to multicast groups, and VTEPs will join those groups using IGMP. This setup ensures that the underlay handles BUM traffic efficiently.\nAn alternative to multicast is ingress replication, also known as headend replication. This option can simplify the configuration by eliminating the need for a multicast underlay. However, headend replication could become a performance issue in larger networks since each VTEP replicates packets. Keep this in mind.\nThere are other alternatives, but they may prove impractical in real-life scenarios.\nBack to business: We’ll go with multicast, and the first step is setting up the PIM infrastructure in the underlay.\nSpines feature ospf feature pim ip pim rp-address 1.0.0.1 ip pim rp-address 1.0.0.2 interface Loopback0 description CORE-LOOPBACK ip address 1.0.0.1/32 ip router ospf 1 area 0 ip pim sparse-mode interface Ethernet1/1 description LEAF-1 no switchport mtu 9216 ip address 10.0.1.1/30 ip ospf network point-to-point ip router ospf 1 area 0.0.0.0 ip pim sparse-mode no shutdown interface Ethernet1/2 description LEAF-2 no switchport mtu 9216 ip address 10.0.1.5/30 ip ospf network point-to-point ip router ospf 1 area 0.0.0.0 ip pim sparse-mode no shutdown router ospf 1 router-id 1.0.0.1 Leafs feature ospf feature pim ip pim rp-address 1.0.0.1 ip pim rp-address 1.0.0.2 interface Loopback0 description CORE-LOOPBACK ip address 1.0.0.3/32 ip router ospf 1 area 0 ip pim sparse-mode interface Ethernet1/1 description SPINE-1 no switchport mtu 9216 ip address 10.0.1.2/30 ip ospf network point-to-point ip router ospf 1 area 0.0.0.0 ip pim sparse-mode no shutdown interface Ethernet1/2 description SPINE-2 no switchport mtu 9216 ip address 10.0.2.2/30 ip ospf network point-to-point ip router ospf 1 area 0.0.0.0 ip pim sparse-mode no shutdown router ospf 1 router-id 1.0.0.3 2. Enable VXLAN and BGP EVPN Enable the required features on all switches.\nfeature nv overlay feature bgp nv overlay evpn 3. BGP EVPN BGP EVPN is implemented to provide controlled learning of the MAC addresses across the fabric. This way, learning by flooding can be largely avoided and replaced with a more scalable approach. Although flood and learn can be used in very limited solutions, all production-grade networks should implement BGP EVPN.\nSpines Pay attention to the AS number selection in combination with the update source. This type of configuration requires increasing the default BGP TTL value (ebgp-multihop).\nrouter bgp 65000 router-id 1.0.0.1 neighbor 1.0.0.3 remote-as 65003 description LEAF-1 update-source loopback0 ebgp-multihop 2 address-family l2vpn evpn send-community extended neighbor 1.0.0.4 remote-as 65004 description LEAF-2 update-source loopback0 ebgp-multihop 2 address-family l2vpn evpn send-community extended Leafs Allocate a unique AS number per leaf to avoid having to bypass the default BGP loop prevention mechanisms.\nrouter bgp 65003 router-id 1.0.0.3 address-family l2vpn evpn retain route-target all neighbor 1.0.0.1 remote-as 65000 description SPINE-1 update-source loopback0 ebgp-multihop 2 address-family l2vpn evpn send-community extended neighbor 1.0.0.2 remote-as 65000 description SPINE-2 update-source loopback0 ebgp-multihop 2 address-family l2vpn evpn send-community extended 4. Configure VXLAN and VNI Mappings on Leafs Map the local VLAN to a virtual network (VNI) and create an interface for it. The interface configuration uses Loopback0 as the source which is the VTEP in the underlay. Multicast group is assigned for BUM replication.\nThis virtual network will be a L2 VNI and thus the forwarding relies on MAC learning.\nfeature vn-segment-vlan-based vlan 100 vn-segment 10000 interface nve1 no shutdown source-interface loopback0 member vni 10000 mcast-group 239.1.1.100 evpn vni 10000 l2 rd auto route-target import auto route-target export auto 5. Attach VLANs to Leaf Ports Adding a server port is simple as creating an access port.\ninterface Ethernet1/3 description SERVER-1 switchport access vlan 100 spanning-tree port type edge spanning-tree bpduguard enable mtu 9216 Validate Validation can be done by using the commands below.\nWhen running ping tests remember that we can only implemented a L2 network that doens’t have a gateway functionality yet. So there is no connectivity to external networks.\nshow ip ospf neighbor show ip pim neighbor show ip pim rp show ip mroute show bgp l2vpn evpn summary show nve peers show mach address-table Lessons This isn’t as hard as they tell you, as long as you keep the network configuration patterns standardized. Automation and management tools become handy as you expand virtual networks, add new servers, and connect new leafs. The security policy plane requires extra attention. It’s not included here, and you might need to consider implementing it on host operating systems, virtual switches, and firewalls. Some massive platform companies have opted to use pure L3 BGP fabric design (the topic of the previous log) instead of VXLAN overlays as discussed in this log. There are good reasons for that: Scaling up: It works for internet-scale networks. Simplicity: No complexity from VXLAN. Control: BGP’s native routing policy controls. Ease of automation: It’s not bad for VXLAN either. East-west traffic: The optimization goal is the fastest route between switches, which BGP does just fine. There is no need to stretch L2 or do segmentation between different tenants, which are some of VXLAN’s key points. Cost: Pure L3 BGP is more cost-efficient due to its simplicity. Efficiency: No overhead from VXLAN headers and no multicast complexity. ",
  "wordCount" : "1179",
  "inLanguage": "en",
  "image": "https://timo-juhani.github.io/papermod-cover.png","datePublished": "2025-02-24T08:34:36+02:00",
  "dateModified": "2025-02-24T08:34:36+02:00",
  "author":{
    "@type": "Person",
    "name": "TJK"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://timo-juhani.github.io/logs/vxlan-in-data-centers/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Logs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://timo-juhani.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://timo-juhani.github.io/" accesskey="h" title="Logs (Alt + H)">Logs</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://timo-juhani.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://timo-juhani.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://timo-juhani.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://timo-juhani.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://timo-juhani.github.io/logs/">Logs</a></div>
    <h1 class="post-title entry-hint-parent">
      VXLAN in Data Centers
    </h1>
    <div class="post-meta"><span title='2025-02-24 08:34:36 +0200 EET'>February 24, 2025</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;TJK

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#quick-refresher" aria-label="Quick Refresher">Quick Refresher</a></li>
                <li>
                    <a href="#topology" aria-label="Topology">Topology</a></li>
                <li>
                    <a href="#configuration" aria-label="Configuration">Configuration</a><ul>
                        
                <li>
                    <a href="#1-underlay" aria-label="1. Underlay">1. Underlay</a><ul>
                        
                <li>
                    <a href="#spines" aria-label="Spines">Spines</a></li>
                <li>
                    <a href="#leafs" aria-label="Leafs">Leafs</a></li></ul>
                </li>
                <li>
                    <a href="#2-enable-vxlan-and-bgp-evpn" aria-label="2. Enable VXLAN and BGP EVPN">2. Enable VXLAN and BGP EVPN</a></li>
                <li>
                    <a href="#3-bgp-evpn" aria-label="3. BGP EVPN">3. BGP EVPN</a><ul>
                        
                <li>
                    <a href="#spines-1" aria-label="Spines">Spines</a></li>
                <li>
                    <a href="#leafs-1" aria-label="Leafs">Leafs</a></li></ul>
                </li>
                <li>
                    <a href="#4-configure-vxlan-and-vni-mappings-on-leafs" aria-label="4. Configure VXLAN and VNI Mappings on Leafs">4. Configure VXLAN and VNI Mappings on Leafs</a></li>
                <li>
                    <a href="#5-attach-vlans-to-leaf-ports" aria-label="5. Attach VLANs to Leaf Ports">5. Attach VLANs to Leaf Ports</a></li>
                <li>
                    <a href="#validate" aria-label="Validate">Validate</a></li></ul>
                </li>
                <li>
                    <a href="#lessons" aria-label="Lessons">Lessons</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="quick-refresher">Quick Refresher<a hidden class="anchor" aria-hidden="true" href="#quick-refresher">#</a></h2>
<p>The main idea behind VXLAN in data centers is the ability to move workloads between the servers without changing the network settings and/or shutting down or restarting the workload. The business need for this capability is rooted in the reasons found from on-demand, elastic scalability, business continuity, or maintenance requirements.</p>
<p>VXLAN is a tunneling protocol which encapsulates the original payload and thus creates separation from the other traffic flows. The concept is similar to what VRF-based technologies implement. The tunnels start and end at VXLAN Tunnel Endpoints or VTEPs.</p>
<p>VTEP does the encapsulation of the traffic. A VTEP comes with two interfaces. One for local bridging purposes and one to provide an IP interface towards the VXLAN core network. Depending on the case, you can see VTEPs deployed on physical switches, hypervisors, or directly on servers&rsquo; operating systems. Having all the key deployment options available should give an idea of the flexibility in setting up the tunnel infrastructure.</p>
<p>So if VTEPs are the core concept in the forwarding, how does the network learn and distribute the information about VTEPs? The two most common options are MP-BGP EVPN and flooding (multicast) control plane solutions. The forwarding decision is based on the destination MAC address. If the MAC is not local to the VTEP, the packet will be encapsulated in a VXLAN header and sent to the remote VTEP over the VXLAN core network. If the MAC is local to the VTEP, the traffic is switched just normally without VXLAN.</p>
<p>Time to get hands on.</p>
<h2 id="topology">Topology<a hidden class="anchor" aria-hidden="true" href="#topology">#</a></h2>
<p>Typical CLOS topology.</p>
<p><img alt="Topology" loading="lazy" src="/images/clos-fabric-bgp.png"></p>
<h2 id="configuration">Configuration<a hidden class="anchor" aria-hidden="true" href="#configuration">#</a></h2>
<p>Since we&rsquo;re dealing with standalone NX-OS devices, let&rsquo;s split the configuration into manageable tasks that follow a logical order.</p>
<h3 id="1-underlay">1. Underlay<a hidden class="anchor" aria-hidden="true" href="#1-underlay">#</a></h3>
<p>For the underlay, we need a simple OSPF setup that provides inter-loopback connectivity within the fabric. The links are point-to-point, so we don&rsquo;t need the OSPF DR process to run.</p>
<p>In addition to OSPF, multicast is required to handle BUM traffic replication in the underlay. Without multicast support, VTEPs wouldn&rsquo;t know where to send BUM traffic. Later in the configuration, we&rsquo;ll map VNIs to multicast groups, and VTEPs will join those groups using IGMP. This setup ensures that the underlay handles BUM traffic efficiently.</p>
<p>An alternative to multicast is ingress replication, also known as headend replication. This option can simplify the configuration by eliminating the need for a multicast underlay. However, headend replication could become a performance issue in larger networks since each VTEP replicates packets. Keep this in mind.</p>
<p>There are other alternatives, but they may prove impractical in real-life scenarios.</p>
<p>Back to business: We&rsquo;ll go with multicast, and the first step is setting up the PIM infrastructure in the underlay.</p>
<h4 id="spines">Spines<a hidden class="anchor" aria-hidden="true" href="#spines">#</a></h4>
<pre tabindex="0"><code>feature ospf
feature pim

ip pim rp-address 1.0.0.1
ip pim rp-address 1.0.0.2

interface Loopback0
  description CORE-LOOPBACK
  ip address 1.0.0.1/32 
  ip router ospf 1 area 0
  ip pim sparse-mode

interface Ethernet1/1
  description LEAF-1
  no switchport
  mtu 9216
  ip address 10.0.1.1/30
  ip ospf network point-to-point
  ip router ospf 1 area 0.0.0.0
  ip pim sparse-mode
  no shutdown

interface Ethernet1/2
  description LEAF-2
  no switchport
  mtu 9216
  ip address 10.0.1.5/30
  ip ospf network point-to-point
  ip router ospf 1 area 0.0.0.0
  ip pim sparse-mode
  no shutdown
  
router ospf 1
  router-id 1.0.0.1
</code></pre><h4 id="leafs">Leafs<a hidden class="anchor" aria-hidden="true" href="#leafs">#</a></h4>
<pre tabindex="0"><code>feature ospf
feature pim

ip pim rp-address 1.0.0.1
ip pim rp-address 1.0.0.2

interface Loopback0
  description CORE-LOOPBACK
  ip address 1.0.0.3/32
  ip router ospf 1 area 0
  ip pim sparse-mode

interface Ethernet1/1
  description SPINE-1
  no switchport
  mtu 9216
  ip address 10.0.1.2/30
  ip ospf network point-to-point
  ip router ospf 1 area 0.0.0.0
  ip pim sparse-mode
  no shutdown

interface Ethernet1/2
  description SPINE-2
  no switchport
  mtu 9216
  ip address 10.0.2.2/30
  ip ospf network point-to-point
  ip router ospf 1 area 0.0.0.0
  ip pim sparse-mode
  no shutdown

router ospf 1
  router-id 1.0.0.3
</code></pre><h3 id="2-enable-vxlan-and-bgp-evpn">2. Enable VXLAN and BGP EVPN<a hidden class="anchor" aria-hidden="true" href="#2-enable-vxlan-and-bgp-evpn">#</a></h3>
<p>Enable the required features on all switches.</p>
<pre tabindex="0"><code>feature nv overlay
feature bgp
nv overlay evpn
</code></pre><h3 id="3-bgp-evpn">3. BGP EVPN<a hidden class="anchor" aria-hidden="true" href="#3-bgp-evpn">#</a></h3>
<p>BGP EVPN is implemented to provide controlled learning of the MAC addresses across the fabric. This way, learning by flooding can be largely avoided and replaced with a more scalable approach. Although flood and learn can be used in very limited solutions, all production-grade networks should implement BGP EVPN.</p>
<h4 id="spines-1">Spines<a hidden class="anchor" aria-hidden="true" href="#spines-1">#</a></h4>
<p>Pay attention to the AS number selection in combination with the update source. This type of configuration requires increasing the default BGP TTL value (ebgp-multihop).</p>
<pre tabindex="0"><code>router bgp 65000
  router-id 1.0.0.1

  neighbor 1.0.0.3 remote-as 65003
    description LEAF-1
    update-source loopback0
    ebgp-multihop 2
    address-family l2vpn evpn
      send-community extended

  neighbor 1.0.0.4 remote-as 65004
    description LEAF-2
    update-source loopback0
    ebgp-multihop 2
    address-family l2vpn evpn
      send-community extended
</code></pre><h4 id="leafs-1">Leafs<a hidden class="anchor" aria-hidden="true" href="#leafs-1">#</a></h4>
<p>Allocate a unique AS number per leaf to avoid having to bypass the default BGP loop prevention mechanisms.</p>
<pre tabindex="0"><code>router bgp 65003
  router-id 1.0.0.3

  address-family l2vpn evpn
    retain route-target all

  neighbor 1.0.0.1 remote-as 65000
    description SPINE-1
    update-source loopback0
    ebgp-multihop 2
    address-family l2vpn evpn
      send-community extended

  neighbor 1.0.0.2 remote-as 65000
    description SPINE-2
    update-source loopback0
    ebgp-multihop 2
    address-family l2vpn evpn
      send-community extended
</code></pre><h3 id="4-configure-vxlan-and-vni-mappings-on-leafs">4. Configure VXLAN and VNI Mappings on Leafs<a hidden class="anchor" aria-hidden="true" href="#4-configure-vxlan-and-vni-mappings-on-leafs">#</a></h3>
<p>Map the local VLAN to a virtual network (VNI) and create an interface for it. The interface configuration uses Loopback0 as the source which is the VTEP in the underlay. Multicast group is assigned for BUM replication.</p>
<p>This virtual network will be a L2 VNI and thus the forwarding relies on MAC learning.</p>
<pre tabindex="0"><code>feature vn-segment-vlan-based

vlan 100
  vn-segment 10000

interface nve1
  no shutdown
  source-interface loopback0
  member vni 10000
    mcast-group 239.1.1.100

evpn
  vni 10000 l2
    rd auto
    route-target import auto
    route-target export auto
</code></pre><h3 id="5-attach-vlans-to-leaf-ports">5. Attach VLANs to Leaf Ports<a hidden class="anchor" aria-hidden="true" href="#5-attach-vlans-to-leaf-ports">#</a></h3>
<p>Adding a server port is simple as creating an access port.</p>
<pre tabindex="0"><code>interface Ethernet1/3
  description SERVER-1
  switchport access vlan 100
  spanning-tree port type edge
  spanning-tree bpduguard enable
  mtu 9216
</code></pre><h3 id="validate">Validate<a hidden class="anchor" aria-hidden="true" href="#validate">#</a></h3>
<p>Validation can be done by using the commands below.</p>
<p>When running ping tests remember that we can only implemented a L2 network that doens&rsquo;t have a gateway functionality yet. So there is no connectivity to external networks.</p>
<pre tabindex="0"><code>show ip ospf neighbor
show ip pim neighbor
show ip pim rp
show ip mroute
show bgp l2vpn evpn summary
show nve peers
show mach address-table
</code></pre><h2 id="lessons">Lessons<a hidden class="anchor" aria-hidden="true" href="#lessons">#</a></h2>
<ul>
<li>This isn&rsquo;t as hard as they tell you, as long as you keep the network configuration patterns standardized.</li>
<li>Automation and management tools become handy as you expand virtual networks, add new servers, and connect new leafs.</li>
<li>The security policy plane requires extra attention. It&rsquo;s not included here, and you might need to consider implementing it on host operating systems, virtual switches, and firewalls.</li>
<li>Some massive platform companies have opted to use pure L3 BGP fabric design (the topic of the previous log) instead of VXLAN overlays as discussed in this log.</li>
<li>There are good reasons for that:
<ul>
<li>Scaling up: It works for internet-scale networks.</li>
<li>Simplicity: No complexity from VXLAN.</li>
<li>Control: BGP&rsquo;s native routing policy controls.</li>
<li>Ease of automation: It&rsquo;s not bad for VXLAN either.</li>
<li>East-west traffic: The optimization goal is the fastest route between switches, which BGP does just fine. There is no need to stretch L2 or do segmentation between different tenants, which are some of VXLAN&rsquo;s key points.</li>
<li>Cost: Pure L3 BGP is more cost-efficient due to its simplicity.</li>
<li>Efficiency: No overhead from VXLAN headers and no multicast complexity.</li>
</ul>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="https://timo-juhani.github.io/logs/bgp-based-data-center-fabric/">
    <span class="title">Next »</span>
    <br>
    <span>BGP Based Data Center Fabric</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share VXLAN in Data Centers on x"
            href="https://x.com/intent/tweet/?text=VXLAN%20in%20Data%20Centers&amp;url=https%3a%2f%2ftimo-juhani.github.io%2flogs%2fvxlan-in-data-centers%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share VXLAN in Data Centers on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ftimo-juhani.github.io%2flogs%2fvxlan-in-data-centers%2f&amp;title=VXLAN%20in%20Data%20Centers&amp;summary=VXLAN%20in%20Data%20Centers&amp;source=https%3a%2f%2ftimo-juhani.github.io%2flogs%2fvxlan-in-data-centers%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share VXLAN in Data Centers on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2ftimo-juhani.github.io%2flogs%2fvxlan-in-data-centers%2f&title=VXLAN%20in%20Data%20Centers">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share VXLAN in Data Centers on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ftimo-juhani.github.io%2flogs%2fvxlan-in-data-centers%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share VXLAN in Data Centers on whatsapp"
            href="https://api.whatsapp.com/send?text=VXLAN%20in%20Data%20Centers%20-%20https%3a%2f%2ftimo-juhani.github.io%2flogs%2fvxlan-in-data-centers%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share VXLAN in Data Centers on telegram"
            href="https://telegram.me/share/url?text=VXLAN%20in%20Data%20Centers&amp;url=https%3a%2f%2ftimo-juhani.github.io%2flogs%2fvxlan-in-data-centers%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share VXLAN in Data Centers on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=VXLAN%20in%20Data%20Centers&u=https%3a%2f%2ftimo-juhani.github.io%2flogs%2fvxlan-in-data-centers%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://timo-juhani.github.io/">Logs</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
